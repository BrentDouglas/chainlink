package io.machinecode.chainlink.core.jsl.fluent;

import io.machinecode.chainlink.core.jsl.InheritanceJobTest;
import io.machinecode.chainlink.core.loader.FluentJobLoader;

import javax.xml.bind.JAXBException;

/**
 * @author <a href="mailto:brent.n.douglas@gmail.com">Brent Douglas</a>
 * @since 1.0
 */
public class FluentJobInheritanceTest extends InheritanceJobTest {

    @Override
    protected FluentJobLoader createRepo() {
        return new FluentJobLoader()
                .add(
                        "job-config-1",
                        Jsl.job("i1")
                                .setVersion("1.0")
                                .setRestartable("true")
                                .addExecution(Jsl.step("step1")
                                        .setAbstract(true)
                                        .setTask(Jsl.batchlet("Doit")
                                        )
                                )
                ).add(
                        "job-default-1",
                        Jsl.job("job1")
                                .setVersion("1.0")
                                .addProperty("job-prop", "job-value")
                                .addListener(Jsl.listener("something")
                                )
                                .addExecution(Jsl.step("step1")
                                        .setTask(Jsl.chunk()
                                                .setReader(Jsl.reader("Reader2")
                                                        .addProperty("", "")
                                                )
                                                .setProcessor(Jsl.processor("Processor2")
                                                )
                                                .setWriter(Jsl.writer("PostingWriter")
                                                        .addProperty("Writer2","")
                                                )
                                                .setCheckpointAlgorithm(Jsl.checkpointAlgorithm("other-checkpoint-algorithm")
                                                )
                                                .setSkippableExceptionClasses(Jsl.skippableExceptionClasses()
                                                        .addInclude("java.lang.Exception")
                                                        .addExclude(Throwable.class)
                                                        .addExclude("javax.xml.bind.JAXBException")
                                                ).setRetryableExceptionClasses(Jsl.retryableExceptionClasses()
                                                        .addInclude("java.lang.Exception")
                                                        .addExclude("java.lang.Throwable")
                                                        .addExclude(JAXBException.class)
                                                ).setNoRollbackExceptionClasses(Jsl.noRollbackExceptionClasses()
                                                        .addInclude(Exception.class)
                                                        .addExclude("java.lang.Throwable")
                                                        .addExclude("javax.xml.bind.JAXBException")
                                                )
                                        ).setPartition(Jsl.partition()
                                                .setStrategy(Jsl.plan()
                                                )
                                        )
                                ).addExecution(Jsl.step("step2")
                                )
                ).add(
                        "job-merge-1",
                        Jsl.job("job1")
                                .setVersion("1.0")
                                .addExecution(Jsl.step("step1")
                                        .setAbstract(true)
                                        .setTask(Jsl.batchlet("Doit")
                                        )
                                ).addExecution(Jsl.step("step2")
                                        .setAbstract(true)
                                        .setTask(Jsl.batchlet("Doit2")
                                        )
                                ).addExecution(Jsl.step("s1")
                                        .setParent("step1")
                                        .setNext("s2")
                                ).addExecution(Jsl.step("s2")
                                        .setParent("step2")
                                )
                ).add(
                        "job-merge-1-result",
                        Jsl.job("job1")
                                .setVersion("1.0")
                                .addExecution(Jsl.step("s1")
                                        .setNext("s2")
                                        .setTask(Jsl.batchlet("Doit")
                                        )
                                )
                                .addExecution(Jsl.step("s2")
                                        .setTask(Jsl.batchlet("Doit2")
                                        )
                                )
                ).add(
                        "job-merge-2",
                        Jsl.job("job1")
                                .setVersion("1.0")
                                .addExecution(Jsl.step("step1")
                                        .setAbstract(true)
                                        .setTask(Jsl.batchlet("Doit")
                                        )
                                )
                                .addExecution(Jsl.step("step2")
                                        .setAbstract(true)
                                        .setTask(Jsl.batchlet("Doit2")
                                        )
                                )
                                .addExecution(Jsl.flow("flow1")
                                        .setAbstract(true)
                                        .addExecution(Jsl.step("s1")
                                                .setParent("step1")
                                                .setAllowStartIfComplete("true")
                                                .setNext("s2")
                                        )
                                        .addExecution(Jsl.step("s2")
                                                .setParent("step2")
                                        )
                                ).addExecution(Jsl.flow("f1")
                                        .setParent("flow1")
                                        .addTransition(Jsl.stop()
                                                .setOn("ERROR")
                                                .setRestart("s1")
                                        )
                                )
                ).add(
                        "job-merge-2-result",
                        Jsl.job("job1")
                                .setVersion("1.0")
                                .addExecution(Jsl.flow("f1")
                                        .addExecution(Jsl.step("s1")
                                                .setAllowStartIfComplete("true")
                                                .setNext("s2")
                                                .setTask(Jsl.batchlet("Doit")
                                                )
                                        )
                                        .addExecution(Jsl.step("s2")
                                                .setTask(Jsl.batchlet("Doit2")
                                                )
                                        ).addTransition(Jsl.stop()
                                                .setOn("ERROR")
                                                .setRestart("s1")
                                        )
                                )

                ).add(
                        "job-merge-3-1",
                        Jsl.job("parent1")
                                .setVersion("1.0")
                                .setAbstract(true)
                                .addListener(Jsl.listener("StepAuditor")
                                )
                ).add(
                        "job-merge-3-2",
                        Jsl.job("job1")
                                .setVersion("1.0")
                                .setParent("parent1")
                                .setJslName("job-merge-3-1")
                                .addExecution(Jsl.step("s1")
                                        .setNext("s2")
                                        .setTask(Jsl.batchlet("Doit")
                                        )
                                ).addExecution(Jsl.step("s2")
                                        .setTask(Jsl.batchlet("Doit2")
                                        )

                                )
                ).add(
                        "job-merge-3-result",
                        Jsl.job("job1")
                                .setVersion("1.0")
                                .addListener(Jsl.listener("StepAuditor")
                                ).addExecution(Jsl.step("s1")
                                        .setNext("s2")
                                        .setTask(Jsl.batchlet("Doit")
                                        )
                                ).addExecution(Jsl.step("s2")
                                        .setTask(Jsl.batchlet("Doit2")
                                        )

                                )
                ).add(
                        "job-merge-4-1",
                        Jsl.job("parent1")
                                .setVersion("1.0")
                                .addListener(Jsl.listener("StepAuditor")
                                ).addExecution(Jsl.step("step1")
                                        .setNext("step2")
                                        .setTask(Jsl.batchlet("Doit")
                                        )
                                ).addExecution(Jsl.step("step2")
                                        .setTask(Jsl.batchlet("Doit2")
                                        )

                                )
                ).add(
                        "job-merge-4-2",
                        Jsl.job("job1")
                                .setVersion("1.0")
                                .addExecution(Jsl.step("s1")
                                        .setParent("step1")
                                        .setJslName("job-merge-4-1")
                                        .setNext("s2")
                                ).addExecution(Jsl.step("s2")
                                        .setParent("step2")
                                        .setJslName("job-merge-4-1")
                                )
                ).add(
                        "job-merge-4-result",
                        Jsl.job("job1")
                                .setVersion("1.0")
                                .addExecution(Jsl.step("s1")
                                        .setNext("s2")
                                        .setTask(Jsl.batchlet("Doit")
                                        )
                                ).addExecution(Jsl.step("s2")
                                        .setTask(Jsl.batchlet("Doit2")
                                        )
                                )
                ).add(
                        "job-merge-5-1",
                        Jsl.job("parent1")
                                .setVersion("1.0")
                                .addListener(Jsl.listener("StepAuditor")
                                ).addExecution(Jsl.step("step1")
                                        .setNext("step2")
                                        .setTask(Jsl.batchlet("Doit")
                                        )
                                ).addExecution(Jsl.step("step2")
                                        .setTask(Jsl.batchlet("Doit2")
                                        )
                                )
                ).add(
                        "job-merge-5-2",
                        Jsl.job("job1")
                                .setVersion("1.0")
                                .setParent("parent1")
                                .setJslName("job-merge-5-1")
                                .addExecution(Jsl.step("s1")
                                        .setParent("step1")
                                        .setJslName("job-merge-5-1")
                                        .setNext("s2")
                                ).addExecution(Jsl.step("s2")
                                        .setParent("step2")
                                        .setJslName("job-merge-5-1")
                                )
                ).add(
                        "job-merge-5-result",
                        Jsl.job("job1")
                                .setVersion("1.0")
                                .setParent("parent1")
                                .setJslName("job-merge-5-1")
                                .addListener(Jsl.listener("StepAuditor")
                                ).addExecution(Jsl.step("s1")
                                        .setNext("s2")
                                        .setTask(Jsl.batchlet("Doit")
                                        )
                                ).addExecution(Jsl.step("s2")
                                        .setTask(Jsl.batchlet("Doit2")
                                        )
                                )
                ).add(
                        "job-merge-6-1",
                        Jsl.job("parent1")
                                .setVersion("1.0")
                                .addListener(Jsl.listener("StepAuditor")
                                ).addExecution(Jsl.step("step1")
                                        .setAbstract(true)
                                        .setTask(Jsl.batchlet("Doit")
                                        )
                                ).addExecution(Jsl.step("step2")
                                        .setAbstract(true)
                                        .setTask(Jsl.batchlet("Doit2")
                                        )
                                ).addExecution(Jsl.flow("flow1")
                                        .setNext("step3")
                                        .addExecution(Jsl.step("s1")
                                                .setParent("step1")
                                                .setAllowStartIfComplete("true")
                                                .setNext("s2")
                                        ).addExecution(Jsl.step("s2")
                                                .setParent("step2")
                                        ).addTransition(Jsl.stop()
                                                .setOn("ERROR")
                                                .setRestart("step3")
                                        )
                                ).addExecution(Jsl.step("step3")
                                        .setTask(Jsl.batchlet("Doit3")
                                        )
                                )
                ).add(
                        "job-merge-6-2",
                        Jsl.job("job1")
                                .setVersion("1.0")
                                .addExecution(Jsl.flow("f1")
                                        .setParent("flow1")
                                        .setJslName("job-merge-6-1")
                                        .setNext("s3")
                                        .addTransition(Jsl.fail()
                                                .setOn("ERROR")
                                        )
                                ).addExecution(Jsl.step("s3")
                                        .setTask(Jsl.batchlet("Doit3")
                                        )
                                )
                ).add(
                        "job-merge-6-result",
                        Jsl.job("job1")
                                .setVersion("1.0")
                                .addExecution(Jsl.flow("f1")
                                        .setNext("s3")
                                        .addExecution(Jsl.step("s1")
                                                .setAllowStartIfComplete("true")
                                                .setNext("s2")
                                                .setTask(Jsl.batchlet("Doit")
                                                )
                                        )
                                        .addExecution(Jsl.step("s2")
                                                .setTask(Jsl.batchlet("Doit2")
                                                )
                                        )
                                        .addTransition(Jsl.fail()
                                                .setOn("ERROR")
                                        )
                                ).addExecution(Jsl.step("s3")
                                        .setTask(Jsl.batchlet("Doit3")
                                        )
                                )
                ).add(
                        "job-merge-7",
                        Jsl.job("job1")
                                .setVersion("1.0")
                                .addExecution(Jsl.step("step1")
                                        .setAbstract(true)
                                        .addProperty("debug","false")
                                        .setTask(Jsl.chunk()
                                                .setItemCount("50")
                                                .setReader(Jsl.reader("PostingReader")
                                                        .addProperty("infile","#{jobProperties['step1.infile']}?:in.txt")
                                                ).setProcessor(Jsl.processor("PostingProcessing")
                                                ).setWriter(Jsl.writer("PostingWriter")
                                                        .addProperty("outfile","#{jobProperties['step1.outfile']}?:out.txt")
                                                )
                                        )
                                ).addExecution(Jsl.step("s1")
                                        .setParent("step1")
                                        .setProperties(Jsl.properties()
                                                .setMerge(true)
                                                .addProperty("debug","true")
                                                .addProperty("step1.infile","postings.out.txt")
                                                .addProperty("step1.outfile","postings.out.txt")
                                        )
                                        .setTask(Jsl.chunk()
                                                .setItemCount("100")
                                        )
                                )
                ).add(
                        "job-merge-7-result",
                        Jsl.job("job1")
                                .setVersion("1.0")
                                .addExecution(Jsl.step("s1")
                                        .addProperty("debug","false")
                                        .addProperty("debug","true")
                                        .addProperty("step1.infile","postings.out.txt")
                                        .addProperty("step1.outfile","postings.out.txt")
                                        .setTask(Jsl.chunk()
                                                .setItemCount("100")
                                                .setReader(Jsl.reader("PostingReader")
                                                        .addProperty("infile","#{jobProperties['step1.infile']}?:in.txt")
                                                ).setProcessor(Jsl.processor("PostingProcessing")
                                                ).setWriter(Jsl.writer("PostingWriter")
                                                        .addProperty("outfile","#{jobProperties['step1.outfile']}?:out.txt")
                                                )
                                        )
                                )
                );
    }
}
